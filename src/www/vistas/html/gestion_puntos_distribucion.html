<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Puntos de Distribuci贸n</title>
    <link rel="stylesheet" href="<?php echo $config['dir_css']; ?>gestion_puntos_distribucion.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .menu-return { display: flex; justify-content: flex-end; margin: 12px 0 6px; }
        .menu-return .btn { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        
        .navbar {
            background: linear-gradient(135deg, #2F855A 0%, #276749 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .user-info .role {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-logout {
            background: #f8d7da;
            color: #721c24;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-logout:hover {
            background: #f5c6cb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(114,28,36,0.2);
        }
    </style>
</head>
<body>
    <?php
    require_once(__DIR__ . '/../../modelos/Sesion.php');
    Sesion::iniciarSesion();
    
    $usuario = Sesion::obtenerUsuario();
    $rol = Sesion::obtenerRol();
    $esAdmin = Sesion::esAdmin();
    ?>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-apple"></i> Sistema de Donaciones
        </div>
        <div class="navbar-user">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span><?php echo htmlspecialchars($usuario); ?></span>
                <span class="role"><?php echo $esAdmin ? ' Admin' : ' Usuario'; ?></span>
            </div>
            <a href="index.php?controlador=Auth&metodo=logout" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="menu-return">
            <a class="btn ghost" href="index.php?controlador=Home&metodo=index" style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fas fa-house"></i> Volver al men煤
            </a>
        </div>
        <header>
            <div class="org-logo"><i class="fas fa-route"></i></div>
            <h1>Puntos de Distribuci贸n</h1>
            <p>Optimiza la cobertura geogr谩fica y ubica r谩pidamente cada centro.</p>
        </header>

        <?php if (isset($mensaje_vista) && !empty($mensaje_vista)): ?>
            <div class="mensaje <?php echo isset($tipo_mensaje) && $tipo_mensaje === 'error' ? 'error' : ''; ?>">
                <?php echo $mensaje_vista; ?>
            </div>
        <?php endif; ?>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number"><?php echo count($puntos_vista); ?></div>
                <div class="stat-label">Puntos Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?php echo count($puntos_vista) > 0 ? date('d/m/Y H:i', strtotime($puntos_vista[0]->getCreatedAt() ?? date('Y-m-d H:i:s'))) : '-'; ?></div>
                <div class="stat-label">ltima alta</div>
            </div>
        </div>

        <div class="layout">
            <section class="map-panel">
                <div class="map-header">
                    <h2><i class="fas fa-map-marked-alt"></i> Mapa de centros</h2>
                    <p>Selecciona un punto para ver detalles o navegar.</p>
                </div>
                <div class="map-frame">
                    <iframe id="mapFrame" src="https://www.google.com/maps?q=Spain&output=embed" allowfullscreen loading="lazy"></iframe>
                </div>
                <div class="map-details" id="mapDetails">
                    <div class="detail-title">Selecciona un punto</div>
                    <div class="detail-body">Haz clic en "Ver en mapa" para centrar la ubicaci贸n y ver a la persona a cargo.</div>
                </div>
            </section>

            <?php if ($esAdmin): ?>
            <section class="form-panel">
                <h2><i class="fas fa-plus-circle"></i> Registrar punto</h2>
                <form method="POST" action="index.php?controlador=PuntoDistribucion&metodo=crear" class="form-grid">
                    <label>
                        Nombre del centro*
                        <input type="text" name="nombre" required placeholder="Ej. Centro Norte" value="<?php echo isset($_POST['nombre']) ? htmlspecialchars($_POST['nombre']) : ''; ?>">
                    </label>
                    <label>
                        Responsable*
                        <input type="text" name="responsable" required placeholder="Persona a cargo" value="<?php echo isset($_POST['responsable']) ? htmlspecialchars($_POST['responsable']) : ''; ?>">
                    </label>
                    <label>
                        Tel茅fono de contacto*
                        <input type="text" name="telefono" required placeholder="Ej. +34 600 000 000" value="<?php echo isset($_POST['telefono']) ? htmlspecialchars($_POST['telefono']) : ''; ?>">
                    </label>
                    <label class="full">
                        Direcci贸n exacta*
                        <textarea name="direccion" rows="2" required placeholder="Calle, ciudad, provincia"><?php echo isset($_POST['direccion']) ? htmlspecialchars($_POST['direccion']) : ''; ?></textarea>
                    </label>
                    <label>
                        Horario
                        <input type="text" name="horario" placeholder="Ej. Lun-Vie 9:00-18:00" value="<?php echo isset($_POST['horario']) ? htmlspecialchars($_POST['horario']) : ''; ?>">
                    </label>
                    <label class="full">
                        Notas / descripci贸n
                        <textarea name="descripcion" rows="2" placeholder="Servicios, accesos, indicaciones"><?php echo isset($_POST['descripcion']) ? htmlspecialchars($_POST['descripcion']) : ''; ?></textarea>
                    </label>
                    <div class="form-actions">
                        <button type="submit" class="btn primary"><i class="fas fa-save"></i> Guardar</button>
                        <a class="btn ghost" href="index.php?controlador=PuntoDistribucion&metodo=listar"><i class="fas fa-undo"></i> Limpiar</a>
                    </div>
                </form>
            </section>
            <?php endif; ?>

        <section class="table-panel">
            <div class="table-header">
                <h2><i class="fas fa-warehouse"></i> Centros registrados</h2>
                <p>Consulta y localiza cada punto de distribuci贸n.</p>
            </div>

            <?php if (empty($puntos_vista)): ?>
                <div class="empty-state">
                    <i class="fas fa-map-pin"></i>
                    <h3>No hay puntos registrados</h3>
                    <p>Agrega el primero con el formulario para comenzar.</p>
                </div>
            <?php else: ?>
                <table>
                    <thead>
                        <tr>
                            <th>Centro</th>
                            <th>Responsable</th>
                            <th>Tel茅fono</th>
                            <th>Horario</th>
                            <th>Ubicaci贸n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($puntos_vista as $punto): ?>
                            <tr>
                                <td>
                                    <div class="cell-title"><?php echo htmlspecialchars($punto->getNombre()); ?></div>
                                    <div class="cell-sub">Creado: <?php echo date('d/m/Y H:i', strtotime($punto->getCreatedAt())); ?></div>
                                </td>
                                <td><?php echo htmlspecialchars($punto->getResponsable()); ?></td>
                                <td><?php echo htmlspecialchars($punto->getTelefono()); ?></td>
                                <td><?php echo $punto->getHorario() ? htmlspecialchars($punto->getHorario()) : 'No indicado'; ?></td>
                                <td>
                                    <div class="cell-sub"><?php echo htmlspecialchars($punto->getDireccion()); ?></div>
                                </td>
                                <td>
                                    <button class="btn small" data-nombre="<?php echo htmlspecialchars($punto->getNombre()); ?>" data-direccion="<?php echo htmlspecialchars($punto->getDireccion()); ?>" data-responsable="<?php echo htmlspecialchars($punto->getResponsable()); ?>" data-telefono="<?php echo htmlspecialchars($punto->getTelefono()); ?>" data-horario="<?php echo htmlspecialchars($punto->getHorario()); ?>" data-descripcion="<?php echo htmlspecialchars($punto->getDescripcion()); ?>">
                                        <i class="fas fa-map-marker-alt"></i> Ver en mapa
                                    </button>
                                    <?php if ($esAdmin): ?>
                                    <form method="POST" action="index.php?controlador=PuntoDistribucion&metodo=eliminar" style="display:inline" onsubmit="return confirm('驴Eliminar este punto?');">
                                        <input type="hidden" name="id" value="<?php echo (int)$punto->getId(); ?>">
                                        <button type="submit" class="btn small" style="margin-top:6px; background:#fee2e2; border-color:#fca5a5; color:#991b1b;">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </form>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </section>

        <footer>
            <p>Ayuda Solidaria &copy; 2025</p>
            <p>Puntos de Distribuci贸n - Base de datos: <?php echo $config['bd_nombre']; ?></p>
        </footer>
    </div>

    <?php
        $puntos_json = json_encode(array_map(function($p) {
            return array(
                'nombre' => $p->getNombre(),
                'direccion' => $p->getDireccion(),
                'responsable' => $p->getResponsable(),
                'telefono' => $p->getTelefono(),
                'horario' => $p->getHorario(),
                'descripcion' => $p->getDescripcion(),
                'created_at' => $p->getCreatedAt()
            );
        }, $puntos_vista), JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_AMP | JSON_HEX_QUOT);
    ?>
    <?php echo '<script>window.puntosDistribucion = ' . ($puntos_json ?: '[]') . ';</script>'; ?>
    <script src="./www/js/gestion_puntos_distribucion.js"></script>
</body>
</html>
